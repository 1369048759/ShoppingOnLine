(function(x){var z=x.parseJSON(x("#Jproducts").html());var f=x(".vi_attribute .cont");var I=(function(){var i=[];f.each(function(){i.push(x(this).find("span").not(".dis"));});return i;})();function G(){var N=x("#JgoodsPrice"),O=parseInt(N.attr("goods_price")),M=0;var i=x(".vi_attribute .cont").find(".curr");i.each(function(){M+=parseInt(x(this).attr("good_price")||0);});N.html(M+O);}function q(){var ac=z,ab=I,Y=x(".vi_attribute .cont");var T="curr",Z="dis";G();for(var W=0,X=ab.length;W<X;W++){var P=[];for(var aa=0,V=I.length;aa<V;aa++){if(W==aa){continue;}if(I[aa].parent().find("."+T).length!=0){P.push(I[aa].parent().find("."+T).attr("good_id"));}}var O=[];for(var N=0,V=ac.length;N<V;N++){var M=ac[N].goods_attr.split("|");for(var S=0,R=P.length;S<R;S++){for(var U=0,Q=M.length;U<Q;U++){if(P[S]==M[U]){break;}}if(U>=Q){break;}}if(S>=R){if(ac[N].product_number>0){O.push(ac[N]);}}}ab[W].each(function(){var ai=x(this),ah=ai.attr("good_id");for(var af=0,ae=O.length;af<ae;af++){var ag=O[af].goods_attr.split("|");for(var ad=0,i=ag.length;ad<i;ad++){if(ah==ag[ad]){break;}}if(ad<i){break;}}if(af>=ae){ai.addClass(Z);}else{ai.removeClass(Z);}});}}function j(ag){if(ag&&ag.status===1){var ac=ag.products;for(var aa=0,ad=ac.length,U;aa<ad;aa++){U=ac[aa];for(var Y=0,S=z.length;Y<S;Y++){if(U.product_id===z[Y].product_id){z[Y].product_number=U.product_number;break;}}}}var M=x(".vi_attribute .cont");var V=x.parseJSON(x("#JproductsDefault").text()),Q,W,ae;if(V==null){V=z[0].goods_attr.split("|");for(var aa=0,ad=I.length;aa<ad;aa++){for(var X=0,N=V.length;X<N;X++){W=I[aa].filter("[good_id="+V[X]+"]");if(W.length>0){W.addClass("curr");q();break;}}}}else{for(var aa=0,ad=I.length;aa<ad;aa++){for(Q in V){W=I[aa].filter("[good_id="+V[Q]+"]");if(W.length>0){W.addClass("curr");q();break;}}}}ae=x("#goodName").text()+"&nbsp;&nbsp;";M.find("span.curr").each(function(){ae+=this.getAttribute("title");});x("#infoProduct").html(ae);x("#1infoProductTotal").text(x("#JgoodsPrice").text());var T=false;var Z=true;var P=[];if(!(V instanceof Array)){for(var O in V){if(V.hasOwnProperty(O)){P.push(V[O]);}}}else{P=V;}for(var aa=0,ad=z.length,af,ab;aa<ad;aa++){af=z[aa];ab=af.goods_attr.split("|");for(var Y=0,S=ab.length;Y<S;Y++){for(var X=0,R=P.length;X<R;X++){if(P[X]===ab[Y]){break;}}if(X<R){continue;}else{break;}}if(Y<S){continue;}else{if(af.is_on_sale=="1"){T=true;if(af.product_number>0){Z=false;}else{Z=true;}}else{T=false;}break;}}if(T){if(Z){x("#JbtnAddCart").hide();x("#JbtnLack").html("暂时缺货").show();x("#Jnotice").show();}else{x("#JbtnAddCart").html("立即购买").show();x("#Jnotice").hide();x("#JbtnLack").hide();}}else{if(aa<ad){x("#JbtnAddCart").html("商品已下架").addClass("btn_addCart_dis").show();x("#JbtnLack").hide();}else{x("#JbtnAddCart").hide();x("#JbtnLack").html("无此货品").show();}x("#Jnotice").hide();}}x.ajax({url:"/goods.php?act=get_goods_stock",type:"get",dataType:"json",context:document.body,data:{id:x("#JgoodsId").html()},success:j});function c(V){var M=V.data,X=M.oItem,T=x(this),ab=I,Z={},N,U=[],S,Y=true,aa;var P="curr",W="dis";X.removeClass(P);T.addClass(P);q();for(var O=ab.length-1;O>=0;O-=1){Z[ab[O].filter(".curr").attr("good_id")]=true;}for(var R=z.length-1;R>=0;R-=1){N=z[R];U=N.goods_attr.split("|");for(var Q=U.length-1;Q>=0;Q-=1){if(!Z[U[Q]]){Y=false;break;}}if(Y){aa=N.goods_id+"-"+N.product_id;break;}else{Y=true;}}if(aa){location.href="/goods/"+aa;}else{x("#JbtnLack").text("无此货品").show();x("#Jnotice").hide();x("#JbtnAddCart").hide();x("#bdshare").hide();}}for(var E=0,m=I.length;E<m;E++){I[E].bind("click",{oItem:I[E]},c);}var g=new $Quantity({obj:"#Jquantity",config:{maxValue:10}});x("#1Jquantity div").click(function(){var i=parseInt(x("#iptQuantityQum1").val());x("#infoProductNum1").text(i);x("#1infoProductTotal").text(i*parseInt(x("#JgoodsPrice1").text()));});var D=x("#Jnotice");D.click(function(){var O=this;if(!O.domNoticeWin){O.domNoticeWin=new $MinWin({obj:"#JnoticeWin"});var i=new $Quantity({obj:O.domNoticeWin.obj.find(".1ui_quantity"),config:{maxValue:10}});O.domNoticeWin.obj.bind("click",O,function(U){var T=U.target,S=U.data;if(x(T).attr("notice_tag")=="cannel"){S.domNoticeWin.hide();U.preventDefault();return false;}if(x(T).attr("notice_tag")=="submit"){var Q={};var R=S.domNoticeWin.obj;Q.email=R.find("input[name=notice_email]").val();if(Q.email.match(/^[\w | \- | \. ]+\@[\w | \- ]+(\.[\w | \-]+)+$/)==null){R.find("input[name=notice_email]").next().show();return false;}else{Q.goods_id=R.find("input[name=notice_id]").val();Q.number=R.find("input[name=notice_num]").val();Q.desc=R.find("textarea[name=notice_desc]").val();Q.linkman=R.find("input[name=notice_linkman]").val();Q.tel=R.find("input[name=notice_tel]").val();Q[hex_md5($getCookie("gn_token_id"))]=1;x.ajax({url:"/user.php?act=act_add_booking",type:"POST",dataType:"json",data:Q,success:function(W){var V=W;if(V.status==1){if(!S.domSuccWin){S.domSuccWin=new $MinWin({obj:"#JnoticeWinSucc"});}S.domSuccWin.show();S.domNoticeWin.hide();setTimeout(function(){S.domSuccWin.hide();},3000);}else{alert(V.info);}}});}}});var M=O.domNoticeWin.obj.find("input[name=notice_email]");M.focus(function(){M.next().hide();});M.blur(function(){if(x(this).val().match(/^[\w | \- | \. ]+\@[\w | \- ]+(\.[\w | \-]+)+$/)==null){M.next().show();}else{M.next().hide();}});var P=O.domNoticeWin.obj.find("textarea[name=notice_desc]");var N=new $FocusBlur({otxt:P.get(0),config:{defValue:"请在此描述你需订购的商品颜色等信息"}});}O.domNoticeWin.show();return false;});x(window.document).bind("click",function(O){var i=this;if(i.flag==1){var N=O.target,M=x("#Jcart");if(x(N).closest(M).length==0){x("#JcartBd").slideUp(400,function(){M.removeClass("cart_hover");});}i.flag=0;}});var n=x("#JbtnAddCart");n.bind("click",function(M){if(x(this).hasClass("btn_addCart_dis")||x(this).hasClass("btn_addCart_quehuo")){M.stopPropagation();M.preventDefault();return false;}var i=v();if(i==null){return false;}$addCartPro(i,function(N){var O=N;switch(O.error){case 0:window.location.href="/cart";break;case 2:alert("库存不足");break;case 4:alert("商品已下架，不能购买");break;case 7:alert("最多可以购买10件同一种商品");break;case 30:window.location.href="/buy_now.php?step=checkout&goods="+O.goods_id+"&product="+O.product_id+"&number="+O.goods_number;break;default:alert(O.message);break;}});M.stopPropagation();M.preventDefault();return false;});function v(){var N={quick:1,spec:[],goods_id:x("#JgoodsId").html(),number:1,parent:0};var P=x(".vi_attribute .cont"),M=P.length;for(var O=0;O<M;O++){if(P.eq(O).find(".curr").length==0){break;}else{N.spec.push(P.eq(O).find(".curr").attr("good_id"));}}if(O<M){var Q=P.eq(O).parent().find("dt").text();Q=Q.replace(/[^\w\u4e00-\u9fa5]/g,"");alert("请先选择商品"+(Q==null?" ":Q));return null;}N.number=parseInt(x("#Jquantity .1ui_quantity_num").val())||1;return N;}function K(){var i=x("#JcartBd");i.html('<div class="cart_loading"></div>');$getCartInfo(function(O){var T=O,M=x("#JcartBd"),R=x("#Jcart .cart_hd em");if(T.goods_list.length==0){M.html('<div class="cart_empty">您的购物车是空的，快去挑选喜欢的商品吧！</div>');R.html(0);}else{var P="",Q=0,S=T.goods_list.length,U=T.goods_list;for(var N=0;N<S;N++){P+='<li class="pro"><div class="ui_pimg"><a href=/goods/'+U[N].goods_id+' hidefocus="true" target="_blank" class="img"><img src="'+U[N].goods_thumb+'" width="50" height="50" alt="'+U[N].goods_name+U[N].goods_attr+'" /></a></div><p class="ui_pname"><a href=/goods/'+U[N].goods_id+' hidefocus="true" target="_blank">'+U[N].goods_name+U[N].goods_attr+'</a></p><div class="price"><span class="ui_pprice"><em>&yen;</em>'+U[N].goods_price+'</span><span class="num">&times;'+U[N].goods_number+"</span></div></li>";Q+=parseInt(U[N].goods_number)||0;}P='<ul class="cart_list">'+P+"</ul>";P+='<div class="sumary">共<em class="fn_hl">'+Q+'</em>件产品，合计：<span class="ui_price"><em>&yen;</em>'+T.total.goods_price+'</span></div><div class="toCart fn_clear"><a href="/cart" hidefocus="true" class="btn" target="_self">去结算</a></div>';P='<div class="cart_cont">'+P+"</div>";M.html(P);R.html(Q);}});}var y=x("#JviImgs .panel"),t=y.find("li");var m=Math.ceil(t.length/5);for(var E=0,s="";E<m;E++){s+='<ul class="item"></ul>';}if(s.length!=0){y.append(s);}t.each(function(i){var M=x(this);var N=Math.floor(i/5);M.appendTo(y.find("ul").eq(N));});var k=new $ImgView({obj:"#JviImgs .vi_imgs_small",oBigImg:"#JviImgs .vi_imgs_big img",config:{isDelay:true}});k.init();var w={};w.oOptions=x("#JtuijList .select");w.cssSeleted="selected";w.onum=x("#JtuijTotal .num em");w.oprice=x("#JtuijTotal .ui_price em").eq(1);w.odiscount=x("#JtuijTotal .discount span");w.btnCart=x("#JvituijAdd");w.cssDis="btn_dis";w.domjprice=x(".vi_tuij_pro .op .ui_pprice");w.init=function(){var P=this;P.oOptions.addClass(w.cssSeleted);var O=0;for(var N=0,M=P.domjprice.length;N<M;N++){O=(parseFloat(P.oOptions.eq(N).attr("sale_price"))||0)+(parseFloat(P.oOptions.eq(N).attr("goods_spec_price"))||0);P.domjprice.eq(N).html("<em>&yen;</em>"+O);}P.countResult();};w.countResult=function(){var R=this;var O=R.oOptions,M=O.length,N=0,Q=0,S=0;for(var P=0;P<M;P++){if(O.eq(P).hasClass(R.cssSeleted)){N++;Q+=parseFloat(O.eq(P).attr("sale_price")||0);S+=parseFloat(O.eq(P).attr("del_price")||0);Q=Q+(parseFloat(O.eq(P).attr("goods_spec_price"))||0);S=S+(parseFloat(O.eq(P).attr("goods_spec_price"))||0);}}R.onum.html(N);R.oprice.html($round(Q,2));R.odiscount.html($round(S-Q<0?0:S-Q,2));if(N==0){R.btnCart.addClass(R.cssDis);}else{R.btnCart.removeClass(R.cssDis);}};w.selectOption=function(N){var i=N.data,M=x(this);if(M.hasClass(i.cssSeleted)){M.removeClass(i.cssSeleted);}else{M.addClass(i.cssSeleted);}i.countResult();};w.init();w.oOptions.bind("click",w,w.selectOption);w.btnCart.bind("click",w,function(U){var Q=U.data,N=x(this);if(N.hasClass(Q.cssDis)){return false;}var V=Q.oOptions,T=V.length,O,S=[];for(var R=0;R<T;R++){if(V.eq(R).hasClass(Q.cssSeleted)){O={};O.quick=1;O.goods_id=V.eq(R).attr("goods_id");var M=x.trim(V.eq(R).attr("goods_spec"));if(M){O.spec=M.split("|");}else{O.spec=[];}O.number=1;O.parent=0;S.push(O);}}if(S.length==0){return false;}var P=0;for(var R=0,T=S.length;R<T;R++){$addCartPro(S[R],function(X){P++;var Y=X;if(Y.error==0){}else{if(Y.error==2){alert("库存不足");}else{if(Y.error==4){alert("商品已下架，不能购买");}else{if(Y.error==7){alert("最多可以购买10件同一种商品");}else{alert(Y.message);}}}}if(R==P){K();var W=x(window);W.scrollTop(0);x("#Jcart").addClass("cart_hover");var i=x("#JcartBd");i.slideDown();window.document.flag=1;}});}return false;});var o=$Tab.play({oTab:"#JviTab",config:{selectorPanel:".vi_tab_con",selectorItem:".vi_tab_item",selectorOptions:".vi_tab_options",selectorOption:"li",cssOptionCurr:"curr",onBeforeMove:function(){var N=x(".vi_tab_optionsFix").offset().top;var i=x(window),M=i.scrollTop();if(N<M){i.scrollTop(N);}}}});var h=new $FixedtoTop({obj:"#JviTabCon",config:{start:x(".vi_tab_optionsFix").offset().top}});var H=(function(i){if(H){return H;}return window.$Popup=function(W){if(!W.content){return;}var M=i("#popup").length>0?i("#popup"):i('<div class="vi-popup" id="popup"><div class="vi-popup-mask" id="popupMask"></div><div class="vi-popup-con" id="popupCon"></div></div>'),O=M.find("#popupCon"),Q=i(W.content),S=W.top||"20%",N=W.width,R=W.btnClose,T=W.onInit,P=W.onHide;R.click(function(){V();});T&&T(Q);U();function U(){M.appendTo("body").show();O.html(Q.show()).css({top:S,width:N});}function V(){P&&P(Q);M.hide();O.children().hide().appendTo("body");}};})(jQuery);x("#showOriginalImg").click(function(){H({content:"#originalImgCon",top:"50px",width:"920px",btnClose:x("#originalImgCon a.pop_shut"),onInit:function(i){i.find("#albumList img:first").click();}});return false;});x("#showVideo").click(function(){H({content:"#videoCon",top:"50px",width:"750px",btnClose:x("#videoCon a.pop_shut"),onInit:function(i){var M=i.find("iframe");M.attr("src",M.attr("bsrc"));},onHide:function(i){var M=i.find("iframe");M.attr("src","");}});return false;});var p=x("#albumListBar"),L=x("#originalImgCon"),u=p.find("#albumList"),A=L.find("#albumBigImg"),C=u.children(),F=100,b=p.find("#albumLeft"),l=p.find("#albumRight"),r=L.find("#btnBigImgLeft"),J=L.find("#btnBigImgRight"),a=8,d=C.length,e=0;if(d>a){b.addClass("prev_none");l.removeClass("next_none");}else{b.addClass("prev_none");l.addClass("next_none");}b.add(l).click(function(){var i=x(this),M=i.hasClass("pcs_prev"),N=M?-1:1;if(x(this).hasClass((M?"prev_none":"next_none"))){return false;}e+=N;if(e===0||e===d-a){M?b.addClass("prev_none"):l.addClass("next_none");}u.animate({left:-(e*F)},300);M?l.removeClass("next_none"):b.removeClass("prev_none");return false;});u.find("img").click(function(i){B(x(this).parent());return false;}).each(function(){this.setAttribute("src",this.getAttribute("thumb_url"));});r.add(J).click(function(){var i=u.children(".products_pcsitem_cur")[r.is(this)?"prev":"next"]();B(i);});function B(i){A.attr("src",i.children("img").attr("original_src"));i.addClass("products_pcsitem_cur").siblings().removeClass("products_pcsitem_cur");r.add(J).show();if((i.index()===0||i.index()===d-1)&&i.hasClass("products_pcsitem_cur")){(i.index()===0?r:J).hide();}}})(jQuery);